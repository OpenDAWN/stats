<!doctype html>
<meta charset="utf-8"/>

<link rel="stylesheet" type="text/css" href="./index.css"/>

<script src="./bundle.js"></script>

<script>
	var q = require('queried');
	var on = require('emmy/on');
	var Draggable = require('draggy');
</script>

<style>
	.play {
		display: block;
		width: 40px;
		height: 40px;
		border: 0;
		background: none;
		text-align: center;
	}
	.play:after{
		content: "▶"
	}
	.play-pause:after{
		content: "❙❙";
		letter-spacing: -.5rem;
		margin-left: -.7rem;
	}
</style>

<section>
	<audio src="./assets/chopin.mp3" class="audio"></audio>
	<button class="play"></button>
	<input class="frequency" type="range" value="5000" min="0" max="20000"/>
	<input class="Q" type="range" value="5" min="1" max="100"/>
</section>

<script>
	var ctx = new AudioContext();

	//Bind play button
	var playBtn = q('.play');
	var audioEl = q('.audio');
	var freqEl = q('.frequency');
	var qEl = q('.Q');

	on(playBtn, 'click', function () {
		if (audioEl.paused) {
			audioEl.play();
			playBtn.classList.add('play-pause');
		}
		else {
			audioEl.pause();
			playBtn.classList.remove('play-pause');
		}
	});


	//Create generator node
	var oscNode = ctx.createOscillator();
	oscNode.type = 'sine';
	oscNode.frequency.value = 200;
	oscNode.start();
	on(freqEl, 'change', function () {
		oscNode.frequency.value = this.value;
	});


	//Create volume controller
	var gainNode = ctx.createGain();
	gainNode.gain.value = 1; //1000000000;


	//Hook up painter
	var Stats = require('web-audio-stats');
	var stats = new Stats(gainNode, ctx, {labels: false});
	playBtn.parentNode.appendChild(stats.element);


	//Make draggable
	new Draggable(stats.element);


	//Create filter processor
	var filterNode = ctx.createBiquadFilter();

	filterNode.type = 'lowpass';
	filterNode.Q.value = 5;
	filterNode.frequency.value = 5000;

	//change params
	on(qEl, 'input', function () {
		filterNode.Q.value = this.value;
	});
	on(freqEl, 'input', function () {
		filterNode.frequency.value = this.value;
	});





	//Connect audio nodes
	var sourceNode = ctx.createMediaElementSource(audioEl);
	// oscNode.connect(gainNode);
	sourceNode.connect(filterNode);
	filterNode.connect(gainNode);
	stats.connect(ctx.destination);
</script>